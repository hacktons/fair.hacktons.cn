(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{397:function(e,t,a){"use strict";a.r(t);var s=a(42),n=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"flutter-fair-a-new-package-used-to-update-widget-tree-dynamically"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#flutter-fair-a-new-package-used-to-update-widget-tree-dynamically"}},[e._v("#")]),e._v(" Flutter Fair: A new package used to update widget tree dynamically")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1600/1*uzMOc9unz1cAuMh0ZwWCVQ.png",alt:"fair logo"}})]),e._v(" "),a("blockquote",[a("p",[e._v("Original published on medium.com "),a("a",{attrs:{href:"https://medium.com/p/98f6f94cb2bf",target:"_blank",rel:"noopener noreferrer"}},[e._v("Flutter Fair: A new package used to update widget tree dynamically"),a("OutboundLink")],1)])]),e._v(" "),a("h2",{attrs:{id:"why-create-flutter-fair"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#why-create-flutter-fair"}},[e._v("#")]),e._v(" Why create Flutter Fair?")]),e._v(" "),a("p",[e._v("Dynamic feature is almost mentioned in every cross-platform framework. From traditional Web/H5 to React Native, many mobile products depend on dynamic ability to dispatch new features or bug fix. And some team use RN rather than Native, just because RN pages can be updated through remote bundle files.")]),e._v(" "),a("p",[e._v("However this case is not possible for Flutter as it can violate the "),a("a",{attrs:{href:"https://developer.apple.com/app-store/review/guidelines/#software-requirements",target:"_blank",rel:"noopener noreferrer"}},[e._v("AppStore’s review guidelines"),a("OutboundLink")],1),e._v(". And the Flutter team has removed code push from its roadmap for 2019: "),a("a",{attrs:{href:"https://github.com/flutter/flutter/issues/14330#issuecomment-485565194",target:"_blank",rel:"noopener noreferrer"}},[e._v("Code Push / Hot Update / out of band updates #14330"),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("Flutter Fair is aimed to update widget tree without code push. This bring us the ability to dispatch new UI widgets/pages. We take control of how to generate widget tree with bundle files. After widgets are constructed, they will be rendered by Flutter engine. These dynamic widgets/pages can also work with predefined BLOC component inside Flutter App.")]),e._v(" "),a("h2",{attrs:{id:"prototype-exploration"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#prototype-exploration"}},[e._v("#")]),e._v(" Prototype exploration")]),e._v(" "),a("p",[e._v("In order to design the Fair package, we did some prototype exploration to make sure we can handle this. Including community research to find valuable resources.")]),e._v(" "),a("p",[e._v("If you have already read the Flutter documents, you may known that Flutter pipeline has several stages. There are three trees related to UI:")]),e._v(" "),a("ul",[a("li",[e._v("Widget tree")]),e._v(" "),a("li",[e._v("Element tree")]),e._v(" "),a("li",[e._v("RenderObject tree")])]),e._v(" "),a("p",[e._v("All we need to do is generate the widget tree in a proper way, then leave it to Flutter itself.")]),e._v(" "),a("p",[e._v("To make a dynamic widget, we use json structure to describe the widget configuration. In Flutter, we declare UI with nested widgets layer, this make json reasonable and quite simple.")]),e._v(" "),a("p",[e._v("Here is a ListView constructed by json description.")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1600/0*K66AmAmhBJEprgj6.png",alt:"img"}})]),e._v(" "),a("p",[e._v("JSON description:")]),e._v(" "),a("div",{staticClass:"language-dart line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-dart"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"className"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"ListView.builder"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"na"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"itemBuilder"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"#(bizColorLabelBuilder)"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"itemCount"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("50")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br")])]),a("p",[e._v("Dart source code:")]),e._v(" "),a("div",{staticClass:"language-dart line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-dart"}},[a("code",[e._v("ListView"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("builder")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("\n  itemBuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" bizColorLabelBuilder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  itemCount"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("50")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br")])]),a("p",[e._v("In this demo, we’ve finally figure out three things:")]),e._v(" "),a("ol",[a("li",[e._v("JSON based definition of DSL bundle")]),e._v(" "),a("li",[e._v("Variable reference in Widget parameters")]),e._v(" "),a("li",[e._v("Widget convertor used to construct a Widget from JSON")])]),e._v(" "),a("h2",{attrs:{id:"fair-flutter-over-the-air"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fair-flutter-over-the-air"}},[e._v("#")]),e._v(" Fair — Flutter over the air")]),e._v(" "),a("p",[e._v("Our demo is still far away from stable package. So we need to think more about what feature is required if we wish to make a useable flutter package.")]),e._v(" "),a("blockquote",[a("p",[e._v("I/O definition")])]),e._v(" "),a("p",[e._v("Our main purpose is to deliver widgets description as bundle file, so it can be update through local assets or URI resource.")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1600/0*AdLD-ste2U49vvJm.png",alt:"IO direction"}})]),e._v(" "),a("p",[e._v("From the developer’s point of view, we hope that the developer will be aware of the development changes as little as possible. The use of Fair should be transparent in details as much as possible. This requires that we provide a middleware (compiler) to implement this “transparent action”.")]),e._v(" "),a("p",[e._v("In the perspective of Flutter, we need to correctly identify the products of the convention format. This requires that we provide a DartVM capable parser (runtime) that does “run” the artifacts.")]),e._v(" "),a("p",[e._v("From the App perspective, we need to manage artifacts, such as loading, persistence, version control, etc. This requires us to provide a set of back-end product management system and mobile loading system.")]),e._v(" "),a("p",[e._v("According to the I/O relationship from different perspectives, we can plan several modules coarse-grained：")]),e._v(" "),a("ul",[a("li",[e._v("The Fair Plugin: responsible for loading, parsing, and finally displaying the bundle in the form of flutter.")]),e._v(" "),a("li",[e._v("Fair Binding Tool: assists with build tools that provide automated transformation capabilities.")]),e._v(" "),a("li",[e._v("Fair Manager Server: simple Resource management service.")]),e._v(" "),a("li",[e._v("Fair Manager API: Android/iOS side and services used with it")])]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1600/0*GodzIJ7k7t4M3ZFl.png",alt:"img"}})]),e._v(" "),a("blockquote",[a("p",[e._v("Hands on Fair SDK")])]),e._v(" "),a("p",[e._v("Before moving on to the technical details of Fair, let’s take a look at how to use the SDK. The recommended access posture is as follows: wrap the App in a FairApp component, and you can have fun with all the other widgets:")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1600/0*TjPFF6GBgKWjWDkn.png",alt:"img"}})]),e._v(" "),a("p",[e._v("In FairApp, each dynamic page is a FairWidget that can provide a “bundle” with input:")]),e._v(" "),a("div",{staticClass:"language-dart line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-dart"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("FairWidget")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("\n  path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'assets/bundle/lib_page_dynamic_widget.fair.bin'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n  data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'content'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'Red Box'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br")])]),a("p",[e._v("Where did this bin come from? The bin resource is a product that Fair can identify, which can be understood as a bundle. It can be written by hand or generated automatically through Fair. To turn a ready-made Flutter page into a bundle, you need to add an annotation:")]),e._v(" "),a("ol",[a("li",[e._v("Add the @FairPatch annotation to the target page")]),e._v(" "),a("li",[e._v("Add the @FairWell annotation to the data object")])]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1600/0*fECj-wrEciq1qY7F.png",alt:"img"}}),e._v("\nRed box sample")]),e._v(" "),a("p",[e._v("Currently, not all Flutter widgets can be converted painlessly with one click. Fair supports transformation of layout classes by default, which requires no logical operations in the build. If there is logic, you need to manually encapsulate or provide the proxy binding object.")]),e._v(" "),a("h2",{attrs:{id:"fair-architecture"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fair-architecture"}},[e._v("#")]),e._v(" Fair architecture")]),e._v(" "),a("p",[e._v("Flutter Fair is evolved from prototype, many external APIs has changed many times in the early stage of development, until they gradually converged and stabilized in the later stage. In the coding process, we need to consider the final effect. The package cannot be arbitrary as in the prototype, we have been convergent parameters to improve readability.")]),e._v(" "),a("p",[e._v("The Fair package can be rendered in a plain structure diagram, with the front and back servers removed, there are three pieces:")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1600/0*g93Od4zIwx_e0XnH.png",alt:"img"}})]),e._v(" "),a("p",[e._v("In the “runtime” section, it includes the bundle resource loader, the parser, and the component agent layer. The “compiler” section is not like a language compiler. Fair Compiler is a compilation tool based on the build runner mechanism of the Flutter. It is mainly used to generate binding and bundle for dart code.")]),e._v(" "),a("blockquote",[a("p",[e._v("Version compatibility")])]),e._v(" "),a("p",[e._v("Everyone who developed Flutter knows that the Flutter version iterates very fast, so it’s worth thinking about how to do a good job of version compatibility.")]),e._v(" "),a("p",[e._v("Some tech teams may have been developed early and used an “older version” such as 1.17.x. As of this writing (2020.11.03), the stable version of flutter is 1.22.x now. Although Fair’s API rarely uses a version-specific API, but in order to implement dynamic components, we had to generate a component map in advance, which is a product of full coupling with the flutter version.")]),e._v(" "),a("p",[e._v("The flutter was 1.20.x when we developed it, so we generated the flutter component of this version by default. To accommodate the multiple versions, we extract the version sensitive logic into a fair_version library.So once flutter releases a new stable version, we can quickly generate a new corresponding fair_version.")]),e._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Switch to another stable flutter version")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("dependency_overrides")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("fair_version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("git")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("url")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("//github.com/wuba/fair.git\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("ref")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" main\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" fair_version/flutter_1_12_13\n")])]),e._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[e._v("1")]),a("br"),a("span",{staticClass:"line-number"},[e._v("2")]),a("br"),a("span",{staticClass:"line-number"},[e._v("3")]),a("br"),a("span",{staticClass:"line-number"},[e._v("4")]),a("br"),a("span",{staticClass:"line-number"},[e._v("5")]),a("br"),a("span",{staticClass:"line-number"},[e._v("6")]),a("br"),a("span",{staticClass:"line-number"},[e._v("7")]),a("br")])]),a("blockquote",[a("p",[e._v("Widget mapping")])]),e._v(" "),a("p",[e._v("By writing the component mapping table, Fair can support more widgets, either from the Flutter framework or from three-party components.")]),e._v(" "),a("p",[e._v("For example we customized a CustomTag component that needed to generate the binding mapping component and we also wanted to generate additional mapping components for the package component of the convex_bottom_bar community. You can do this:")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1600/0*1tHTy3bWGIHdylZt.png",alt:"img"}})]),e._v(" "),a("p",[e._v("The generated code snippet is as follows:")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1600/0*LLSsXzqKPCPWBZ5R.png",alt:"img"}})]),e._v(" "),a("blockquote",[a("p",[e._v("Bundle generation")])]),e._v(" "),a("p",[e._v("In order to achieve seamless integration, our goal is to support the generation of business bundles directly from the Flutter layout. Using the build_runner mechanism, we can nicely combine the bundle build with project Flutter. So ideally, all the developer has to do is add the annotations, and then the flutter compiler will generate the artifacts for you.")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1600/0*T5Y5qCyDfKy1YZtm.png",alt:"img"}})]),e._v(" "),a("h2",{attrs:{id:"dsl-ast"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dsl-ast"}},[e._v("#")]),e._v(" DSL & AST")]),e._v(" "),a("p",[e._v("I guess those of you reading so far are really interested in Flutter. These two nouns are very common, and both are general concepts that have nothing to do with language:")]),e._v(" "),a("ul",[a("li",[e._v("DSL : Domain Specific Language")]),e._v(" "),a("li",[e._v("AST: Abstract Syntax Tree")])]),e._v(" "),a("p",[e._v("In Flutter Fair, DSL is the expression of our intermediates, and AST is the expression of our primary products for analysis.")]),e._v(" "),a("p",[e._v("In Fair Complier, we have designed a layer of Fairc, which is an important part of an auxiliary compilation tool that provides DSL generation capabilities based on the AST to help developers quickly generate DSL bundles and Proxy files from source code. Here is a brief introduction to the practical use of Fair.")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1600/0*l2sAnSyyGGfOYjjT.png",alt:"img"}})]),e._v(" "),a("p",[e._v("The idea of DSL generation is shown in the figure above, which is to generate CustomAST from the source code through fair_ast_get, and then CustomAST through fair_dsl_gen to generate the target Fair DSL. Let’s look at the overall workflow of the converter.")]),e._v(" "),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1600/0*JwNMTvJvTbcMQ4qc.png",alt:"img"}})]),e._v(" "),a("p",[e._v("First of all, we abstract the syntax nodes of 100+ into identifiers, literals, expressions and syntax blocks, and the other five classes, including 30+ kinds of commonly used nodes. At the same time, we strip away the information irrelevant to business parsing, and only retain the key information in the original Node. Makes node resolution clearer.")]),e._v(" "),a("p",[e._v("The original syntax tree has a large amount of data, and the Visitor schema is not convenient for us to deal with the business in context, so we need to simplify and construct our own syntax tree to facilitate our subsequent processing")]),e._v(" "),a("h2",{attrs:{id:"next"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#next"}},[e._v("#")]),e._v(" Next")]),e._v(" "),a("p",[e._v("The Flutter Fair package is a little exploration on Flutter dynamic update. It will be open source soon: https://github.com/wuba.")]),e._v(" "),a("p",[e._v("You can also find document about Flutter Fair at https://fair.hacktons.cn/")]),e._v(" "),a("blockquote",[a("p",[e._v("It’s mandarin, sorry for not providing English version, any i18n translation is appreciated!!😁")])])])}),[],!1,null,null,null);t.default=n.exports}}]);